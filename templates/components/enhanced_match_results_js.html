<!-- Enhanced Match Results JavaScript -->
<script>
// Enhanced results display functions
let currentMatchData = null;
let savedMatchups = JSON.parse(localStorage.getItem('savedMatchups') || '[]');

// Toggle parameter breakdown details
function toggleDetails() {
    const breakdown = document.getElementById('parameterBreakdown');
    const toggle = document.getElementById('detailsToggle');
    const insights = document.getElementById('additionalInsights');
    
    if (breakdown && toggle) {
        const isVisible = breakdown.style.display !== 'none';
        
        breakdown.style.display = isVisible ? 'none' : 'block';
        toggle.classList.toggle('active', !isVisible);
        toggle.querySelector('span').textContent = isVisible ? 'Show Details' : 'Hide Details';
        
        // Show insights when details are shown
        if (insights) {
            insights.style.display = isVisible ? 'none' : 'block';
        }
    }
}

// Enhanced show results function
function showResults(data) {
    currentMatchData = data;
    
    // Update match info
    document.getElementById('matchType').textContent = data.score_type;
    document.getElementById('matchTitle').textContent = data.home_team.name + ' vs ' + data.away_team.name;
    
    // Update team details with enhanced visualization
    updateTeamDetails('home', data.home_team, data.home_strength, data.home_probability);
    updateTeamDetails('away', data.away_team, data.away_strength, data.away_probability);
    
    // Update expected goals
    const expectedGoals = calculateExpectedGoals(data.home_strength, data.away_strength);
    document.getElementById('expectedGoals').textContent = expectedGoals.toFixed(1);
    
    // Update predicted score
    updatePredictedScore(data);
    
    // Update prediction with confidence visualization
    updatePredictionWithConfidence(data);
    
    // Update parameter breakdown
    updateParameterBreakdown(data);
    
    // Update insights
    updateInsights(data);
    
    // Display betting odds if available
    if (data.betting_odds) {
        displayBettingOdds(data.betting_odds, data.home_team.name, data.away_team.name);
    }
    
    // Update save button state
    updateSaveButtonState();
}

// Update team details with enhanced visualization
function updateTeamDetails(position, team, strength, probability) {
    document.getElementById(position + 'Name').textContent = team.name;
    document.getElementById(position + 'League').textContent = team.league;
    document.getElementById(position + 'Strength').textContent = Math.round(strength);
    document.getElementById(position + 'Win').textContent = probability + '%';
    
    // Update strength bar
    const strengthBar = document.getElementById(position + 'StrengthBar');
    if (strengthBar) {
        strengthBar.style.width = strength + '%';
    }
    
    // Update team badge with league flag
    const badge = document.getElementById(position + 'ResultBadge');
    if (badge) {
        badge.textContent = getTeamFlag(team.league);
    }
}

// Calculate expected goals based on team strengths
function calculateExpectedGoals(homeStrength, awayStrength) {
    const avgStrength = (homeStrength + awayStrength) / 2;
    const homeAdvantage = 0.1; // 10% home advantage
    const adjustedStrength = avgStrength * (1 + homeAdvantage);
    
    // Scale to realistic goal expectation (1.5 to 4.0 goals)
    return 1.5 + (adjustedStrength / 100) * 2.5;
}

// Update predicted score with top probable scores
function updatePredictedScore(data) {
    const scores = calculateTopProbableScores(data);
    
    // Show the most likely score
    document.getElementById('predictedScore').textContent = scores[0].score;
    
    // Update confidence based on the top score probability
    const confidence = scores[0].probability * 100;
    
    const confidenceFill = document.querySelector('.predicted-score .confidence-fill');
    const confidenceText = document.querySelector('.predicted-score .confidence-text');
    
    if (confidenceFill) confidenceFill.style.width = confidence + '%';
    if (confidenceText) confidenceText.textContent = Math.round(confidence) + '% Confidence';
    
    // Add top 5 scores display
    updateTopScoresDisplay(scores);
}

// Calculate top 5 most probable scores
function calculateTopProbableScores(data) {
    const homeStrength = data.home_strength / 100;
    const awayStrength = data.away_strength / 100;
    const homeAdv = 0.1; // Home advantage
    
    // Expected goals based on team strengths
    const homeExpected = (homeStrength + homeAdv) * 2.5;
    const awayExpected = awayStrength * 2.2;
    
    const scores = [];
    
    // Generate possible scores (0-0 to 4-4)
    for (let h = 0; h <= 4; h++) {
        for (let a = 0; a <= 4; a++) {
            // Poisson distribution approximation
            const homeProb = poissonProbability(h, homeExpected);
            const awayProb = poissonProbability(a, awayExpected);
            const totalProb = homeProb * awayProb;
            
            scores.push({
                score: `${h} - ${a}`,
                homeGoals: h,
                awayGoals: a,
                probability: totalProb
            });
        }
    }
    
    // Sort by probability and return top 5
    return scores.sort((a, b) => b.probability - a.probability).slice(0, 5);
}

// Poisson probability calculation
function poissonProbability(k, lambda) {
    return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
}

// Factorial helper function
function factorial(n) {
    if (n <= 1) return 1;
    return n * factorial(n - 1);
}

// Update top scores display
function updateTopScoresDisplay(scores) {
    const predictedScoreElement = document.getElementById('predictedScore');
    if (!predictedScoreElement) return;
    
    // Create or update top scores container
    let topScoresContainer = document.querySelector('.top-scores-container');
    if (!topScoresContainer) {
        topScoresContainer = document.createElement('div');
        topScoresContainer.className = 'top-scores-container';
        predictedScoreElement.parentNode.appendChild(topScoresContainer);
    }
    
    topScoresContainer.innerHTML = `
        <div class="top-scores-title">Most Likely Scores:</div>
        <div class="top-scores-grid">
            ${scores.map((score, index) => `
                <div class="score-option ${index === 0 ? 'primary' : ''}">
                    <div class="score-text">${score.score}</div>
                    <div class="score-prob">${(score.probability * 100).toFixed(1)}%</div>
                </div>
            `).join('')}
        </div>
    `;
}

// Update prediction with enhanced confidence visualization
function updatePredictionWithConfidence(data) {
    document.getElementById('predictionResult').textContent = data.favorite + ' to win';
    
    // Calculate confidence level
    const diff = Math.abs(data.home_probability - data.away_probability);
    let confidence = 'Low Confidence';
    let confidenceLevel = 1;
    
    if (diff > 30) {
        confidence = 'High Confidence';
        confidenceLevel = 4;
    } else if (diff > 20) {
        confidence = 'Medium-High Confidence';
        confidenceLevel = 3;
    } else if (diff > 10) {
        confidence = 'Medium Confidence';
        confidenceLevel = 2;
    }
    
    document.getElementById('confidence').textContent = confidence;
    document.getElementById('predictionDetails').textContent = data.explanation;
    
    // Update confidence dots
    const dots = document.querySelectorAll('.confidence-dots .dot');
    dots.forEach((dot, index) => {
        dot.classList.toggle('active', index < confidenceLevel);
    });
}

// Update parameter breakdown
function updateParameterBreakdown(data) {
    // This would be populated with real parameter data from the API
    // For now, using mock data based on the analysis
    const parameters = [
        {
            name: 'Team Strength',
            weight: '40%',
            homeValue: data.home_strength,
            awayValue: data.away_strength
        },
        {
            name: 'Recent Form',
            weight: '25%',
            homeValue: Math.min(100, data.home_strength * 0.9),
            awayValue: Math.min(100, data.away_strength * 0.85)
        },
        {
            name: 'Home Advantage',
            weight: '15%',
            homeValue: 85,
            awayValue: 15
        },
        {
            name: 'Head-to-Head',
            weight: '20%',
            homeValue: data.home_probability * 1.3,
            awayValue: data.away_probability * 1.3
        }
    ];
    
    // Update parameter breakdown display
    const parameterGrid = document.querySelector('.parameter-grid');
    if (parameterGrid && currentMatchData) {
        parameterGrid.innerHTML = parameters.map(param => `
            <div class="parameter-item">
                <div class="param-header">
                    <span class="param-name">${param.name}</span>
                    <span class="param-weight">${param.weight}</span>
                </div>
                <div class="param-labels">
                    <span class="param-label-home">${currentMatchData.home_team.name}</span>
                    <span class="param-vs">VS</span>
                    <span class="param-label-away">${currentMatchData.away_team.name}</span>
                </div>
                <div class="param-bars">
                    <div class="param-bar home">
                        <div class="param-fill" style="width: ${Math.min(100, param.homeValue)}%"></div>
                    </div>
                    <div class="param-vs">VS</div>
                    <div class="param-bar away">
                        <div class="param-fill" style="width: ${Math.min(100, param.awayValue)}%"></div>
                    </div>
                </div>
            </div>
        `).join('');
    }
}

// Update insights
function updateInsights(data) {
    const expectedGoals = calculateExpectedGoals(data.home_strength, data.away_strength);
    const strengthDiff = Math.abs(data.home_strength - data.away_strength);
    const sameLeague = data.score_type === 'Same League';
    
    // Goal expectation insight
    let goalInsight = 'Moderate scoring expected';
    if (expectedGoals > 3) goalInsight = 'High-scoring match likely';
    else if (expectedGoals < 2) goalInsight = 'Low-scoring encounter';
    
    // Match importance insight
    let importanceInsight = 'Regular fixture';
    if (!sameLeague) importanceInsight = 'Cross-league showcase';
    else if (strengthDiff < 10) importanceInsight = 'Evenly matched contest';
    
    // Historical trend insight
    let trendInsight = 'Balanced recent encounters';
    if (strengthDiff > 20) trendInsight = 'Dominant team expected';
    else if (strengthDiff < 5) trendInsight = 'Very close matches typical';
    
    // Update insight displays
    document.getElementById('goalInsight').textContent = goalInsight;
    document.getElementById('importanceInsight').textContent = importanceInsight;
    document.getElementById('trendInsight').textContent = trendInsight;
}

// Save matchup functionality
function saveMatchup() {
    if (!currentMatchData) return;
    
    const matchup = {
        id: Date.now(),
        homeTeam: currentMatchData.home_team.name,
        awayTeam: currentMatchData.away_team.name,
        prediction: currentMatchData.favorite,
        homeProbability: currentMatchData.home_probability,
        awayProbability: currentMatchData.away_probability,
        savedAt: new Date().toISOString()
    };
    
    // Check if already saved
    const existingIndex = savedMatchups.findIndex(m => 
        m.homeTeam === matchup.homeTeam && m.awayTeam === matchup.awayTeam
    );
    
    if (existingIndex >= 0) {
        // Update existing
        savedMatchups[existingIndex] = matchup;
    } else {
        // Add new
        savedMatchups.unshift(matchup);
        savedMatchups = savedMatchups.slice(0, 10); // Keep only last 10
    }
    
    localStorage.setItem('savedMatchups', JSON.stringify(savedMatchups));
    updateSaveButtonState();
    
    // Show feedback
    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="btn-icon">âœ…</span><span>Saved!</span>';
    saveBtn.classList.add('saved');
    
    setTimeout(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.classList.remove('saved');
    }, 2000);
}

// Update save button state
function updateSaveButtonState() {
    if (!currentMatchData) return;
    
    const saveBtn = document.getElementById('saveBtn');
    const isSaved = savedMatchups.some(m => 
        m.homeTeam === currentMatchData.home_team.name && 
        m.awayTeam === currentMatchData.away_team.name
    );
    
    if (isSaved) {
        saveBtn.classList.add('saved');
        saveBtn.innerHTML = '<span class="btn-icon">âœ…</span><span>Saved</span>';
    } else {
        saveBtn.classList.remove('saved');
        saveBtn.innerHTML = '<span class="btn-icon">ðŸ’¾</span><span>Save Analysis</span>';
    }
}

// Share matchup functionality
function shareMatchup() {
    if (!currentMatchData) return;
    
    const shareText = `ðŸ”® ${currentMatchData.home_team.name} vs ${currentMatchData.away_team.name}
ðŸ“Š Prediction: ${currentMatchData.favorite} to win
ðŸ  ${currentMatchData.home_team.name}: ${currentMatchData.home_probability}%
âœˆï¸ ${currentMatchData.away_team.name}: ${currentMatchData.away_probability}%

âš¡ Analyzed with Spooky Football Engine`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Football Match Prediction',
            text: shareText,
            url: window.location.href
        });
    } else {
        // Fallback to clipboard
        navigator.clipboard.writeText(shareText).then(() => {
            const shareBtn = document.querySelector('.share-btn');
            const originalText = shareBtn.innerHTML;
            shareBtn.innerHTML = '<span class="btn-icon">âœ…</span><span>Copied!</span>';
            
            setTimeout(() => {
                shareBtn.innerHTML = originalText;
            }, 2000);
        });
    }
}

// Export analysis functionality
function exportAnalysis() {
    if (!currentMatchData) return;
    
    const exportData = {
        match: `${currentMatchData.home_team.name} vs ${currentMatchData.away_team.name}`,
        prediction: currentMatchData.favorite,
        probabilities: {
            home: currentMatchData.home_probability,
            away: currentMatchData.away_probability
        },
        strengths: {
            home: currentMatchData.home_strength,
            away: currentMatchData.away_strength
        },
        explanation: currentMatchData.explanation,
        bettingOdds: currentMatchData.betting_odds,
        analyzedAt: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `${currentMatchData.home_team.name}_vs_${currentMatchData.away_team.name}_analysis.json`;
    link.click();
    
    // Show feedback
    const exportBtn = document.querySelector('.export-btn');
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<span class="btn-icon">âœ…</span><span>Exported!</span>';
    
    setTimeout(() => {
        exportBtn.innerHTML = originalText;
    }, 2000);
}

// Initialize enhanced results functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('Enhanced match results initialized');
});
</script>