<!-- Consolidated App JavaScript -->
<script>
// Team data
const allTeams = {
    'Premier League': [
        'Arsenal', 'Aston Villa', 'Bournemouth', 'Brentford', 'Brighton & Hove Albion',
        'Burnley', 'Chelsea', 'Crystal Palace', 'Everton', 'Fulham',
        'Liverpool', 'Luton Town', 'Manchester City', 'Manchester United', 'Newcastle United',
        'Nottingham Forest', 'Sheffield United', 'Tottenham Hotspur', 'West Ham United', 'Wolverhampton Wanderers'
    ],
    'La Liga': [
        'Almería', 'Athletic Club', 'Atletico Madrid', 'Barcelona', 'Cadiz',
        'Celta Vigo', 'Getafe', 'Girona', 'Granada CF', 'Las Palmas',
        'Mallorca', 'Osasuna', 'Rayo Vallecano', 'Real Betis', 'Real Madrid',
        'Real Sociedad', 'Sevilla', 'Valencia', 'Villarreal', 'Alaves'
    ],
    'Serie A': [
        'AC Milan', 'AS Roma', 'Atalanta', 'Bologna', 'Cagliari',
        'Empoli', 'Fiorentina', 'Frosinone', 'Genoa', 'Hellas Verona',
        'Inter', 'Juventus', 'Lazio', 'Lecce', 'Monza',
        'Napoli', 'Salernitana', 'Sassuolo', 'Torino', 'Udinese'
    ],
    'Bundesliga': [
        '1. FC Heidenheim 1846', '1. FC Köln', '1. FC Union Berlin', 'Bayer Leverkusen', 'Bayern München',
        'Borussia Dortmund', 'Borussia Mönchengladbach', 'Darmstadt 98', 'Eintracht Frankfurt', 'FC Augsburg',
        'RB Leipzig', 'SC Freiburg', 'SV Werder Bremen', 'TSG Hoffenheim', 'VfB Stuttgart',
        'VfL Bochum 1848', 'VfL Wolfsburg', 'Mainz 05'
    ],
    'Ligue 1': [
        'Brest', 'Clermont', 'Le Havre', 'Lens', 'Lille',
        'Lorient', 'Lyon', 'Marseille', 'Metz', 'Monaco',
        'Montpellier', 'Nantes', 'Nice', 'Paris Saint Germain', 'Reims',
        'Rennes', 'Strasbourg', 'Toulouse'
    ],
    'International': [
        'Argentina', 'Belgium', 'Brazil', 'Croatia', 'Denmark',
        'England', 'France', 'Germany', 'Italy', 'Mexico',
        'Morocco', 'Netherlands', 'Nigeria', 'Poland', 'Portugal',
        'Senegal', 'Serbia', 'South Korea', 'Spain', 'Switzerland',
        'Uruguay', 'USA', 'Wales'
    ]
};

// Initialize team dropdowns
function initializeTeams() {
    console.log('Initializing teams...');
    populateDropdown('home');
    populateDropdown('away');
}

// Populate dropdown
function populateDropdown(side) {
    const dropdownContent = document.getElementById(side + 'DropdownContent');
    if (!dropdownContent) {
        console.error('Dropdown content not found for', side);
        return;
    }
    
    dropdownContent.innerHTML = '';
    
    Object.keys(allTeams).forEach(league => {
        // Add league header
        const leagueHeader = document.createElement('div');
        leagueHeader.className = 'league-header';
        leagueHeader.textContent = league;
        dropdownContent.appendChild(leagueHeader);
        
        // Add teams
        allTeams[league].forEach(team => {
            const teamOption = document.createElement('div');
            teamOption.className = 'team-option';
            teamOption.innerHTML = `<span class="team-flag">${getTeamFlag(league)}</span><span>${team}</span>`;
            teamOption.onclick = () => selectTeam(side, team);
            dropdownContent.appendChild(teamOption);
        });
    });
}

// Get team flag
function getTeamFlag(league) {
    const flags = {
        'Premier League': '🏴',
        'La Liga': '🇪🇸',
        'Serie A': '🇮🇹',
        'Bundesliga': '🇩🇪',
        'Ligue 1': '🇫🇷',
        'International': '🌍'
    };
    return flags[league] || '⚽';
}

// Show dropdown
function showDropdown(side) {
    const dropdown = document.getElementById(side + 'Dropdown');
    if (dropdown) {
        dropdown.classList.add('show');
        // Hide other dropdown
        const otherSide = side === 'home' ? 'away' : 'home';
        const otherDropdown = document.getElementById(otherSide + 'Dropdown');
        if (otherDropdown) {
            otherDropdown.classList.remove('show');
        }
    }
}

// Filter teams
function filterTeams(side) {
    const searchInput = document.getElementById(side + 'TeamSearch');
    const filter = searchInput.value.toLowerCase();
    const dropdownContent = document.getElementById(side + 'DropdownContent');
    
    if (!dropdownContent) return;
    
    dropdownContent.innerHTML = '';
    let hasResults = false;
    
    Object.keys(allTeams).forEach(league => {
        const filteredTeams = allTeams[league].filter(team => 
            team.toLowerCase().includes(filter)
        );
        
        if (filteredTeams.length > 0) {
            hasResults = true;
            
            const leagueHeader = document.createElement('div');
            leagueHeader.className = 'league-header';
            leagueHeader.textContent = league;
            dropdownContent.appendChild(leagueHeader);
            
            filteredTeams.forEach(team => {
                const teamOption = document.createElement('div');
                teamOption.className = 'team-option';
                teamOption.innerHTML = `<span class="team-flag">${getTeamFlag(league)}</span><span>${team}</span>`;
                teamOption.onclick = () => selectTeam(side, team);
                dropdownContent.appendChild(teamOption);
            });
        }
    });
    
    if (!hasResults) {
        dropdownContent.innerHTML = '<div class="no-results">No teams found</div>';
    }
}

// Select team
function selectTeam(side, teamName) {
    const searchInput = document.getElementById(side + 'TeamSearch');
    const hiddenInput = document.getElementById(side + 'Team');
    const dropdown = document.getElementById(side + 'Dropdown');
    
    if (searchInput && hiddenInput && dropdown) {
        searchInput.value = teamName;
        hiddenInput.value = teamName;
        dropdown.classList.remove('show');
        updateButton();
    }
}

// Update button state
function updateButton() {
    const homeTeam = document.getElementById('homeTeam').value;
    const awayTeam = document.getElementById('awayTeam').value;
    const analyzeBtn = document.getElementById('analyzeBtn');
    const btnText = analyzeBtn.querySelector('.btn-text');
    
    if (homeTeam && awayTeam && homeTeam !== awayTeam) {
        analyzeBtn.disabled = false;
        btnText.textContent = 'ANALYZE MATCH';
    } else {
        analyzeBtn.disabled = true;
        btnText.textContent = homeTeam && awayTeam && homeTeam === awayTeam ? 
            'Select different teams' : 'Select both teams';
    }
}

// Swap teams
function swapTeams() {
    const homeInput = document.getElementById('homeTeam');
    const awayInput = document.getElementById('awayTeam');
    const homeSearch = document.getElementById('homeTeamSearch');
    const awaySearch = document.getElementById('awayTeamSearch');
    
    if (homeInput && awayInput && homeSearch && awaySearch) {
        const tempValue = homeInput.value;
        homeInput.value = awayInput.value;
        awayInput.value = tempValue;
        
        const tempSearch = homeSearch.value;
        homeSearch.value = awaySearch.value;
        awaySearch.value = tempSearch;
        
        updateButton();
    }
}

// Analyze match
async function analyzeMatch() {
    const homeTeam = document.getElementById('homeTeam').value;
    const awayTeam = document.getElementById('awayTeam').value;
    
    if (!homeTeam || !awayTeam) {
        alert('Please select both teams');
        return;
    }
    
    const analyzeBtn = document.getElementById('analyzeBtn');
    const btnText = analyzeBtn.querySelector('.btn-text');
    const btnIcon = analyzeBtn.querySelector('.btn-icon');
    
    // Show loading state
    analyzeBtn.disabled = true;
    btnText.textContent = 'Analyzing...';
    btnIcon.textContent = '⚡';
    btnIcon.style.animation = 'spin 1s linear infinite';
    
    try {
        const response = await fetch('/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                home_team: homeTeam,
                away_team: awayTeam
            })
        });
        
        const data = await response.json();
        
        // Show results
        document.getElementById('resultsContainer').style.display = 'block';
        document.getElementById('resultContent').style.display = 'block';
        
        // Update match analysis
        updateMatchAnalysis(data);
        
        // Display betting odds
        if (data.betting_odds) {
            displayBettingOdds(data.betting_odds, homeTeam, awayTeam);
        }
        
        // Smooth scroll to results
        setTimeout(() => {
            document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 200);
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error analyzing match. Please try again.');
    } finally {
        // Reset button
        analyzeBtn.disabled = false;
        btnText.textContent = 'ANALYZE MATCH';
        btnIcon.textContent = '⚡';
        btnIcon.style.animation = '';
    }
}

// Update match analysis
function updateMatchAnalysis(data) {
    // Match header
    document.getElementById('matchType').textContent = data.score_type || 'Match Analysis';
    document.getElementById('matchTitle').textContent = `${data.home_team.name} vs ${data.away_team.name}`;
    
    // Home team
    document.getElementById('homeName').textContent = data.home_team.name;
    document.getElementById('homeLeague').textContent = data.home_team.league;
    document.getElementById('homeStrength').textContent = Math.round(data.home_strength);
    document.getElementById('homeWin').textContent = data.home_probability + '%';
    document.getElementById('homeStrengthBar').style.width = data.home_strength + '%';
    
    // Away team
    document.getElementById('awayName').textContent = data.away_team.name;
    document.getElementById('awayLeague').textContent = data.away_team.league;
    document.getElementById('awayStrength').textContent = Math.round(data.away_strength);
    document.getElementById('awayWin').textContent = data.away_probability + '%';
    document.getElementById('awayStrengthBar').style.width = data.away_strength + '%';
    
    // Prediction
    const predictionElement = document.getElementById('predictionResult');
    if (predictionElement) {
        predictionElement.textContent = data.favorite + ' to win';
    }
    
    // Expected goals
    if (data.expected_goals && document.getElementById('expectedGoals')) {
        document.getElementById('expectedGoals').textContent = data.expected_goals.toFixed(1);
    }
}

// Display betting odds
function displayBettingOdds(bettingOdds, homeTeam, awayTeam) {
    console.log('Displaying betting odds:', bettingOdds);
    
    // Show container
    const container = document.getElementById('bettingOddsContainer');
    if (container) {
        container.style.display = 'block';
    }
    
    // Update team names
    const homeElements = ['homeOddsTeam', 'homeOddsLogo'];
    const awayElements = ['awayOddsTeam', 'awayOddsLogo'];
    
    homeElements.forEach(id => {
        const el = document.getElementById(id);
        if (el && id.includes('Team')) el.textContent = homeTeam;
        if (el && id.includes('Logo')) el.textContent = '🏠';
    });
    
    awayElements.forEach(id => {
        const el = document.getElementById(id);
        if (el && id.includes('Team')) el.textContent = awayTeam;
        if (el && id.includes('Logo')) el.textContent = '✈️';
    });
    
    // Update odds
    if (bettingOdds.match_outcome) {
        const mo = bettingOdds.match_outcome;
        updateOddsElement('homeOdds', mo.home_win.odds);
        updateOddsElement('homeOddsProb', mo.home_win.probability + '%');
        updateOddsElement('drawOdds', mo.draw.odds);
        updateOddsElement('drawOddsProb', mo.draw.probability + '%');
        updateOddsElement('awayOdds', mo.away_win.odds);
        updateOddsElement('awayOddsProb', mo.away_win.probability + '%');
    }
    
    if (bettingOdds.goals_market) {
        const gm = bettingOdds.goals_market;
        updateOddsElement('over25Odds', gm.over_2_5.odds);
        updateOddsElement('over25Prob', gm.over_2_5.probability + '%');
        updateOddsElement('under25Odds', gm.under_2_5.odds);
        updateOddsElement('under25Prob', gm.under_2_5.probability + '%');
    }
    
    if (bettingOdds.btts_market) {
        const btts = bettingOdds.btts_market;
        updateOddsElement('bttsYesOdds', btts.yes.odds);
        updateOddsElement('bttsYesProb', btts.yes.probability + '%');
        updateOddsElement('bttsNoOdds', btts.no.odds);
        updateOddsElement('bttsNoProb', btts.no.probability + '%');
    }
}

// Helper function to update odds elements
function updateOddsElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
    }
}

// Hide dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.search-container')) {
        document.querySelectorAll('.search-dropdown').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('App initialized');
    initializeTeams();
    
    // Add spin animation
    if (!document.getElementById('spin-style')) {
        const style = document.createElement('style');
        style.id = 'spin-style';
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }
});

// Make functions globally accessible
window.filterTeams = filterTeams;
window.showDropdown = showDropdown;
window.swapTeams = swapTeams;
window.analyzeMatch = analyzeMatch;
window.updateButton = updateButton;
</script>