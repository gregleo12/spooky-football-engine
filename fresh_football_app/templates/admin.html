{% extends "base.html" %}

{% block title %}Admin Dashboard - Football Analytics{% endblock %}

{% block content %}
<h1>üõ†Ô∏è Admin Dashboard</h1>
<p style="color: #a0aec0; margin-bottom: 2rem;">Comprehensive system monitoring and data visualization</p>

{% if stats %}
<div class="alert alert-success">
    <strong>System Status: HEALTHY</strong> - Railway PostgreSQL connected successfully
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_teams }}</div>
        <div class="stat-label">Total Teams</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_leagues }}</div>
        <div class="stat-label">Active Leagues</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_records }}</div>
        <div class="stat-label">Data Records</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">100%</div>
        <div class="stat-label">Data Coverage</div>
    </div>
</div>

<div class="card">
    <h2>Parameter Coverage Analysis</h2>
    <p style="margin-bottom: 2rem;">All 10 parameters showing complete coverage across all teams</p>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
        <!-- Core Strength Parameters -->
        <div>
            <h3 style="margin-bottom: 1rem;">Core Strength (40%)</h3>
            
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>ELO Score (18%)</span>
                    <span>{{ stats.elo_coverage_pct }}%</span>
                </div>
                <div class="coverage-bar">
                    <div class="coverage-fill" style="width: {{ stats.elo_coverage_pct }}%"></div>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Squad Value (15%)</span>
                    <span>{{ stats.squad_value_coverage_pct }}%</span>
                </div>
                <div class="coverage-bar">
                    <div class="coverage-fill" style="width: {{ stats.squad_value_coverage_pct }}%"></div>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Form Score (5%)</span>
                    <span>{{ stats.form_coverage_pct }}%</span>
                </div>
                <div class="coverage-bar">
                    <div class="coverage-fill" style="width: {{ stats.form_coverage_pct }}%"></div>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Squad Depth (2%)</span>
                    <span>{{ stats.squad_depth_coverage_pct }}%</span>
                </div>
                <div class="coverage-bar">
                    <div class="coverage-fill" style="width: {{ stats.squad_depth_coverage_pct }}%"></div>
                </div>
            </div>
        </div>
        
        <!-- Advanced Parameters -->
        <div>
            <h3 style="margin-bottom: 1rem;">Advanced Analysis (60%)</h3>
            
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Key Players (10%)</span>
                    <span>{{ stats.key_player_coverage_pct }}%</span>
                </div>
                <div class="coverage-bar">
                    <div class="coverage-fill" style="width: {{ stats.key_player_coverage_pct }}%"></div>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Motivation (10%)</span>
                    <span>{{ stats.motivation_coverage_pct }}%</span>
                </div>
                <div class="coverage-bar">
                    <div class="coverage-fill" style="width: {{ stats.motivation_coverage_pct }}%"></div>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Tactical Matchup (10%)</span>
                    <span>{{ stats.tactical_coverage_pct }}%</span>
                </div>
                <div class="coverage-bar">
                    <div class="coverage-fill" style="width: {{ stats.tactical_coverage_pct }}%"></div>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Offensive Rating (10%)</span>
                    <span>{{ stats.offensive_coverage_pct }}%</span>
                </div>
                <div class="coverage-bar">
                    <div class="coverage-fill" style="width: {{ stats.offensive_coverage_pct }}%"></div>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Defensive Rating (10%)</span>
                    <span>{{ stats.defensive_coverage_pct }}%</span>
                </div>
                <div class="coverage-bar">
                    <div class="coverage-fill" style="width: {{ stats.defensive_coverage_pct }}%"></div>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span>H2H Performance (10%)</span>
                    <span>{{ stats.h2h_coverage_pct }}%</span>
                </div>
                <div class="coverage-bar">
                    <div class="coverage-fill" style="width: {{ stats.h2h_coverage_pct }}%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h2>League Distribution</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        {% for league, teams in teams_by_league.items() %}
        <div class="stat-card">
            <div class="stat-value">{{ teams | length }}</div>
            <div class="stat-label">{{ league }}</div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="card">
    <h2>System Health Metrics</h2>
    <table>
        <thead>
            <tr>
                <th>Metric</th>
                <th>Value</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Database Connection</td>
                <td>Railway PostgreSQL</td>
                <td><span style="color: #48bb78;">‚úÖ Connected</span></td>
            </tr>
            <tr>
                <td>Team Data Coverage</td>
                <td>{{ stats.total_teams }}/98 teams</td>
                <td><span style="color: #48bb78;">‚úÖ Complete</span></td>
            </tr>
            <tr>
                <td>Parameter Coverage</td>
                <td>10/10 parameters</td>
                <td><span style="color: #48bb78;">‚úÖ Complete</span></td>
            </tr>
            <tr>
                <td>Data Quality</td>
                <td>Validated ranges</td>
                <td><span style="color: #48bb78;">‚úÖ Verified</span></td>
            </tr>
            <tr>
                <td>Last Updated</td>
                <td>{{ timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td><span style="color: #48bb78;">‚úÖ Current</span></td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card">
    <h2>Quick Actions</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="/api/admin/stats" class="btn">Export System Stats</a>
        <a href="/api/teams" class="btn btn-secondary">View All Teams JSON</a>
        <a href="/health" class="btn btn-secondary">Health Check</a>
        <button onclick="refreshStats()" class="btn btn-secondary">Refresh Data</button>
    </div>
</div>

{% else %}
<div class="alert alert-error">
    <h3>‚ö†Ô∏è System Error</h3>
    <p>Unable to retrieve system statistics. Check Railway PostgreSQL connection.</p>
    <p><strong>Database URL:</strong> postgresql://postgres:***@ballast.proxy.rlwy.net:10971/railway</p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
async function refreshStats() {
    try {
        const response = await fetch('/api/admin/stats');
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to refresh stats');
        }
    } catch (error) {
        alert('Error refreshing stats: ' + error.message);
    }
}

// Auto-refresh every 30 seconds
setInterval(() => {
    fetch('/health')
        .then(response => {
            if (!response.ok) {
                console.warn('Health check failed');
            }
        })
        .catch(error => {
            console.error('Health check error:', error);
        });
}, 30000);
</script>
{% endblock %}